{% extends "base.html" %}
{% load humanize %}
{% block head %}
  {{ block.super }}
  <title>Meu Painel</title>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-4 g-lg-5">

    <div class="col-lg-4">
      <div class="card shadow-sm mb-4 sticky-top" style="top: 2rem;">
        <div class="card-body">
          <h5 class="card-title mb-3">Registro Rápido Pessoal</h5>
          <form method="post" action="{% url 'cria_lista:index' %}">
            {% csrf_token %}
            <div class="mb-3">
              <label for="{{ form.valor.id_for_label }}" class="form-label">{{ form.valor.label }}</label>
              {{ form.valor }}
              <div class="form-text">Renda (+) ou Gasto (-) pessoal.</div>
            </div>
            <div class="mb-3">
              <label for="{{ form.descricao.id_for_label }}" class="form-label">{{ form.descricao.label }}</label>
              {{ form.descricao }}
            </div>
            <div class="mb-3">
              <label for="{{ form.categoria.id_for_label }}" class="form-label">{{ form.categoria.label }}</label>
              {{ form.categoria }}
              <div class="form-text">
                <a href="{% url 'cria_lista:categorias' %}" class="small" target="_blank">Gerenciar categorias</a>
              </div>
            </div>
            <div class="mb-3">
              <label for="{{ form.data.id_for_label }}" class="form-label">{{ form.data.label }}</label>
              {{ form.data }}
            </div>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Adicionar Transação Pessoal
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1 class="h2 mb-0">Meus Envelopes</h1>
        <a href="{% url 'cria_lista:nova_lista' %}" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i> Criar Novo Envelope
        </a>
      </div>

      {% if listas %}
        <div class="row g-4">
          {% for lista in listas %}
          <div class="col-md-6">
            <div class="card h-100 shadow-sm">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-truncate">
                  {{ lista.nome.title }}
                  {% if lista.shared_with.all %}
                    <span class="badge bg-info ms-2" title="Este envelope é compartilhado">
                      <i class="fas fa-users me-1"></i> Compartilhado
                    </span>
                  {% endif %}
                </h5>
              </div>
              <div class="card-body">
                <p class="card-text mb-2">
                  <small class="text-muted">Meta:</small>
                  <strong class="d-block fs-5">R$ {{ lista.meta|floatformat:2|intcomma }}</strong>
                </p>
                <p class="card-text mb-0">
                  <small class="text-muted">Saldo Atual:</small>
                  <strong class="d-block fs-5 {% if lista.diferenca_meta > 0 %}text-success{% else %}text-danger{% endif %}">
                    R$ {{ lista.diferenca_meta|floatformat:2|intcomma }}
                  </strong>
                </p>
              </div>
              <div class="card-footer bg-transparent border-0 p-3 d-flex justify-content-end align-items-center gap-2">
                  <a class="btn btn-primary btn-sm" href="{% url 'cria_lista:detalhe_lista' id_lista=lista.id %}">
                      <i class="fas fa-eye"></i> Ver Transações
                  </a>
                  {% if lista.user == request.user %}
                  <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Mais opções">
                          <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                          <li>
                              <a class="dropdown-item" href="{% url 'cria_lista:editar_lista' id_lista=lista.id %}">
                                  <i class="fas fa-edit fa-fw me-2"></i>Editar Envelope
                              </a>
                          </li>
                          <li><hr class="dropdown-divider"></li>
                          <li>
                              <button type="button" class="dropdown-item text-danger"
                                      data-bs-toggle="modal"
                                      data-bs-target="#deleteConfirmationModal"
                                      data-form-action="{% url 'cria_lista:deletar_lista' lista.id %}"
                                      data-item-name="{{ lista.nome.title|escapejs }}">
                                  <i class="fas fa-trash fa-fw me-2"></i>Excluir
                              </button>
                          </li>
                      </ul>
                  </div>
                  {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-5 rounded-3 bg-body-tertiary">
          <div class="feature-icon text-muted" style="font-size: 4rem">
            <i class="fas fa-box-open"></i>
          </div>
          <h2 class="display-6 mt-3">Nenhum envelope criado</h2>
          <p class="lead text-muted">Que tal criar seu primeiro envelope de orçamento?</p>
          <a class="btn btn-primary mt-3" href="{% url 'cria_lista:nova_lista' %}">
            <i class="fas fa-plus me-2"></i> Crie seu primeiro envelope
          </a>
        </div>
      {% endif %}

      <hr class="my-4">

      <h2 class="h3 mb-3">Últimas Transações Pessoais</h2>
      {% if transacoes_pessoais %}
        <div class="list-group shadow-sm">
          {% for transacao in transacoes_pessoais %}
            <div class="list-group-item d-flex justify-content-between align-items-start gap-3">
              <div class="flex-grow-1">
                <h5 class="mb-1">{{ transacao.descricao.title }}</h5>
                <h4 class="mb-1 {% if transacao.valor > 0 %}text-success{% else %}text-danger{% endif %}">
                  R$ {{ transacao.valor|floatformat:2|intcomma }}
                </h4>
                <small class="text-muted">
                  {{ transacao.data|date:"d/m/Y" }}
                  {% if transacao.categoria %}({{ transacao.categoria.nome }}){% endif %}
                </small>
              </div>
              <a href="{% url 'cria_lista:editar_transacao' id_transacao=transacao.id %}" class="btn btn-sm btn-outline-secondary" title="Editar">
                <i class="fas fa-edit"></i>
              </a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p classt="text-muted">Nenhuma transação pessoal registrada ainda. Use o formulário de "Registro Rápido" para começar.</p>
      {% endif %}

    </div>
  </div>
</div>

{% include 'components/_delete.html' %}
{% include 'components/_pagination.html' %}
{% endblock %}